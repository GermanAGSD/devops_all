<!--python -m http.server 8080-->
<!--File SSE_test.html-->
<!--http://127.0.0.1:8080/SSE_test.html-->

<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SSE Client (HTML)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 20px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-start; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 12px; }
    .ok { color: #0a7; font-weight: 700; }
    .bad { color: #c33; font-weight: 700; }
    .muted { color: #666; }
    input, button, textarea, select { padding: 8px 10px; border-radius: 8px; border: 1px solid #ccc; font: inherit; }
    button { cursor: pointer; }
    textarea { width: 100%; min-height: 140px; resize: vertical; }
    pre { background: #0b1020; color: #d9e1ff; padding: 12px; border-radius: 10px; overflow: auto; max-height: 260px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 6px 8px; border-bottom: 1px solid #eee; vertical-align: top; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#f2f2f2; font-size:12px; }
    .bar { height: 8px; background:#eee; border-radius: 999px; overflow:hidden; }
    .bar > div { height: 100%; background:#3b82f6; width:0%; transition: width .2s; }
    .kv { display:flex; justify-content: space-between; gap: 10px; padding: 4px 0; border-bottom: 1px dashed #eee; }
    .kv:last-child { border-bottom: none; }
    .kv span { color:#333; }
    .kv b { font-weight: 800; }
    .btnRow { display:flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  </style>
</head>
<body>

<h2>SSE Client (HTML)</h2>

<div class="card">
  <div class="row" style="align-items:center;">
    <div>
      <div class="muted">URL</div>
      <input id="url" style="width:520px" value="http://172.30.30.19:8300/sse/host?param=browser" />
    </div>

    <div style="padding-top:18px" class="btnRow">
      <button id="btnConnect">Connect</button>
      <button id="btnDisconnect" disabled>Disconnect</button>
      <button id="btnClear" style="margin-left:8px">Clear</button>
    </div>

    <div style="padding-top:18px">
      <span class="pill">status: <span id="status" class="bad">DISCONNECTED</span></span>
      <span class="pill">last: <span id="lastEvent">-</span></span>
    </div>
  </div>
</div>

<div class="row" style="margin-top:12px;">
  <div class="card" style="flex:1; min-width: 520px;">
    <div class="muted">mediaList</div>
    <div id="mediaEmpty" class="muted" style="margin-top:8px">Пока пусто (ждём init / cursize / complete / ...)</div>

    <div id="mediaWrap" style="display:none; margin-top:8px">
      <table>
        <thead>
        <tr>
          <th>fileName</th>
          <th>fileSize</th>
          <th>progress</th>
          <th>isLoading</th>
        </tr>
        </thead>
        <tbody id="mediaTbody"></tbody>
      </table>
    </div>
  </div>

  <div class="card" style="width: 420px;">
    <div class="muted">Последнее событие</div>
    <div style="margin-top:6px"><b>type:</b> <span id="lastType">-</span></div>
    <div><b>time:</b> <span id="lastTime">-</span></div>
    <div class="muted" style="margin-top:8px">data:</div>
    <pre id="lastData">{}</pre>
  </div>

  <!-- ✅ WEBHOOK: поля + кнопка -->
  <div class="card" style="width: 420px;">
    <div class="muted">Webhook sender</div>

    <div style="margin-top:8px">
      <div class="muted">Webhook URL</div>
      <input id="whUrl" style="width:100%" value="http://172.30.30.19:8000/webhook?param=browser" />
    </div>

    <div class="row" style="margin-top:10px; align-items:end;">
      <div style="flex:1; min-width: 160px;">
        <div class="muted">event</div>
        <input id="whEvent" style="width:100%" value="play" />
      </div>

      <div style="min-width: 210px;">
        <div class="muted">data mode</div>
        <select id="whMode" style="width:100%">
          <option value="auto" selected>auto (JSON else string)</option>
          <option value="json">force JSON</option>
          <option value="string">force string</option>
        </select>
      </div>

      <div>
        <button id="sendWebhook">Send webhook</button>
      </div>
    </div>

    <div style="margin-top:10px">
      <div class="muted">data (JSON или текст)</div>
      <textarea id="whData">{
  "urls": [
    {"url": "http://example.com/video1.mp4"}
  ]
}</textarea>
    </div>

    <div class="muted" style="margin-top:8px">
      result:
      <span id="whStatus" class="pill">idle</span>
    </div>
    <pre id="whOut" style="max-height: 180px; margin-top:8px;">-</pre>
  </div>

  <!-- ✅ Счётчики -->
  <div class="card" style="width: 360px;">
    <div class="muted">Счётчики (всего)</div>
    <div class="kv"><span>message (default)</span><b id="cnt_message">0</b></div>
    <div class="kv"><span>play</span><b id="cnt_play">0</b></div>
    <div class="kv"><span>pause</span><b id="cnt_pause">0</b></div>
    <div class="kv"><span>stop</span><b id="cnt_stop">0</b></div>
    <div class="kv"><span>replay</span><b id="cnt_replay">0</b></div>
    <div class="kv"><span>getinfo</span><b id="cnt_getinfo">0</b></div>
    <div class="kv"><span>setvol</span><b id="cnt_setvol">0</b></div>
    <div class="kv"><span>company</span><b id="cnt_company">0</b></div>
    <div class="kv"><span>registered</span><b id="cnt_registered">0</b></div>
    <div class="kv"><span>ping</span><b id="cnt_ping">0</b></div>
  </div>
</div>

<!-- ✅ Live state -->
<div class="row" style="margin-top: 12px;">
  <div class="card" style="flex:1; min-width: 360px;">
    <div class="muted">Live state (последние данные по типам)</div>
    <div class="kv"><span>volume</span><b id="state_volume">-</b></div>
    <div class="kv"><span>status</span><b id="state_status">-</b></div>
    <div class="kv"><span>position</span><b id="state_position">-</b></div>
    <div class="kv"><span>duration</span><b id="state_duration">-</b></div>
    <div class="kv"><span>urls</span><b id="state_urls">-</b></div>
    <div class="muted" style="margin-top:10px;">raw payload:</div>
    <pre id="state_raw">{}</pre>
  </div>
</div>

<div class="card" style="margin-top:12px">
  <div class="muted">Лог (последние 200 строк)</div>
  <pre id="log"></pre>
</div>

<script>
  // ===== helpers =====
  const $ = (id) => document.getElementById(id);

  function nowStr() {
    return new Date().toLocaleTimeString();
  }

  function logLine(line) {
    const el = $("log");
    const lines = (el.textContent ? el.textContent.split("\n") : []);
    lines.push(line);
    el.textContent = lines.slice(-200).join("\n");
    el.scrollTop = el.scrollHeight;
  }

  function safeJsonParse(s) {
    try { return JSON.parse(s); } catch { return null; }
  }

  function prettyData(d) {
    if (typeof d !== "string") return JSON.stringify(d, null, 2);
    const j = safeJsonParse(d);
    return j ? JSON.stringify(j, null, 2) : d;
  }

  function setStatus(connected) {
    const el = $("status");
    if (connected) {
      el.textContent = "CONNECTED";
      el.className = "ok";
      $("btnConnect").disabled = true;
      $("btnDisconnect").disabled = false;
    } else {
      el.textContent = "DISCONNECTED";
      el.className = "bad";
      $("btnConnect").disabled = false;
      $("btnDisconnect").disabled = true;
    }
  }

  function setLast(type, data) {
    $("lastEvent").textContent = type;
    $("lastType").textContent = type;
    $("lastTime").textContent = nowStr();
    $("lastData").textContent = prettyData(data);
  }

  // ===== webhook sender =====
  function setWhStatus(text) {
    $("whStatus").textContent = text;
  }

  async function sendWebhook() {
    const url = $("whUrl").value.trim();
    const event = $("whEvent").value.trim();
    const raw = $("whData").value;
    const mode = $("whMode").value;

    let data;
    if (mode === "string") {
      data = String(raw);
    } else if (mode === "json") {
      const parsed = safeJsonParse(raw);
      if (parsed === null) {
        setWhStatus("data JSON error");
        $("whOut").textContent = JSON.stringify({ error: "Invalid JSON in data" }, null, 2);
        return;
      }
      data = parsed;
    } else {
      // auto
      const parsed = safeJsonParse(raw);
      data = (parsed === null) ? String(raw) : parsed;
    }

    const body = { event, data };

    setWhStatus("sending...");
    $("whOut").textContent = JSON.stringify({ request: body }, null, 2);

    try {
      const resp = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      const text = await resp.text();
      let parsedResp;
      try { parsedResp = JSON.parse(text); } catch { parsedResp = text; }

      setWhStatus(resp.ok ? `ok (${resp.status})` : `http ${resp.status}`);
      $("whOut").textContent = JSON.stringify(
              { request: body, response: parsedResp, http: { status: resp.status, ok: resp.ok } },
              null,
              2
      );

      logLine(`[${nowStr()}] webhook -> ${resp.status} ${resp.ok ? "OK" : "ERR"}`);
    } catch (e) {
      setWhStatus("fetch error");
      $("whOut").textContent = JSON.stringify({ request: body, error: String(e) }, null, 2);
      logLine(`[${nowStr()}] webhook ERROR: ${e}`);
    }
  }

  $("sendWebhook").addEventListener("click", sendWebhook);

  // ===== counters =====
  const counters = {
    message: 0,
    play: 0,
    pause: 0,
    stop: 0,
    replay: 0,
    getinfo: 0,
    setvol: 0,
    company: 0,
    registered: 0,
    ping: 0
  };

  function inc(type) {
    if (!(type in counters)) counters[type] = 0;
    counters[type] += 1;
    const el = $("cnt_" + type);
    if (el) el.textContent = String(counters[type]);
  }

  // ===== live state =====
  function setState(type, payload) {
    const obj = (typeof payload === "string") ? (safeJsonParse(payload) ?? payload) : payload;
    $("state_raw").textContent = prettyData(obj);

    if (type === "setvol") {
      const volume = (obj && typeof obj === "object")
              ? (obj.volume ?? obj.data?.volume ?? obj.payload?.volume)
              : null;
      if (volume !== null && volume !== undefined) $("state_volume").textContent = String(volume);
    }

    if (type === "getinfo" || type === "message") {
      if (obj && typeof obj === "object") {
        if (obj.status !== undefined) $("state_status").textContent = String(obj.status);
        if (obj.position !== undefined) $("state_position").textContent = String(obj.position);
        if (obj.duration !== undefined) $("state_duration").textContent = String(obj.duration);
        if (obj.volume !== undefined) $("state_volume").textContent = String(obj.volume);
      }
    }

    if (type === "play") {
      let urls = "-";
      if (obj && typeof obj === "object") {
        const u = obj.urls ?? obj.data?.urls ?? obj.payload?.urls;
        if (Array.isArray(u)) {
          urls = u.map(x => (typeof x === "string" ? x : (x.url ?? JSON.stringify(x)))).join(", ");
        } else if (typeof u === "string") {
          urls = u;
        }
      }
      $("state_urls").textContent = urls;
    }
  }

  // ===== mediaList state (как в твоём коде) =====
  const mediaListRef = { current: [] };

  function renderMediaList() {
    const list = mediaListRef.current;

    if (!list.length) {
      $("mediaEmpty").style.display = "block";
      $("mediaWrap").style.display = "none";
      return;
    }

    $("mediaEmpty").style.display = "none";
    $("mediaWrap").style.display = "block";

    const tbody = $("mediaTbody");
    tbody.innerHTML = "";

    for (const item of list) {
      const tr = document.createElement("tr");

      const tdName = document.createElement("td");
      tdName.textContent = item.fileName ?? "-";
      tr.appendChild(tdName);

      const tdSize = document.createElement("td");
      tdSize.textContent = item.fileSize ?? "-";
      tr.appendChild(tdSize);

      const tdProg = document.createElement("td");
      if (typeof item.progress === "number") {
        const wrap = document.createElement("div");
        wrap.className = "bar";
        const fill = document.createElement("div");
        fill.style.width = Math.max(0, Math.min(100, item.progress)) + "%";
        wrap.appendChild(fill);

        const label = document.createElement("div");
        label.className = "muted";
        label.style.marginTop = "4px";
        label.textContent = item.progress + "%";

        tdProg.appendChild(wrap);
        tdProg.appendChild(label);
      } else {
        tdProg.textContent = "-";
      }
      tr.appendChild(tdProg);

      const tdLoad = document.createElement("td");
      tdLoad.textContent = String(!!item.isLoading);
      tr.appendChild(tdLoad);

      tbody.appendChild(tr);
    }
  }

  // ===== SSE connection =====
  let source = null;

  function createSseConnection({
                                 url,
                                 setSseError = () => {},
                                 handleConDis = () => {},
                                 setMediaList = () => {},
                               }) {
    source = new EventSource(url);

    source.onerror = (e) => {
      console.error("SSE error:", e);
      logLine(`[${nowStr()}] ERROR`);
      setSseError(true);
      // EventSource сам пытается переподключаться.
      setStatus(false);
    };

    source.onopen = () => {
      logLine(`[${nowStr()}] OPEN`);
      setStatus(true);
    };

    // default message (без event:)
    source.onmessage = (e) => {
      inc("message");
      setLast("message", e.data);
      setState("message", e.data);
      logLine(`[${nowStr()}] message: ${prettyData(e.data)}`);
    };

    const types = ["play","pause","stop","replay","getinfo","setvol","company","registered","ping","timeout"];
    types.forEach((type) => {
      source.addEventListener(type, (e) => {
        inc(type);
        setLast(type, e.data);
        setState(type, e.data);
        logLine(`[${nowStr()}] ${type}: ${prettyData(e.data)}`);

        if (type === "timeout") setSseError(true);
        if (type === "connect") handleConDis(e, true);
        if (type === "disconnect") handleConDis(e, false);
      });
    });

    // mediaList-ивенты
    source.addEventListener("init", (e) => {
      const update = safeJsonParse(e.data) ?? {};
      logLine(`[${nowStr()}] init: ${prettyData(update)}`);
      setLast("init", update);

      const newMediaList = [...mediaListRef.current];
      update.isLoading = true;
      newMediaList.push(update);
      mediaListRef.current = newMediaList;
      setMediaList(newMediaList);
      renderMediaList();
    });

    source.addEventListener("cursize", (e) => {
      const payload = safeJsonParse(e.data);
      logLine(`[${nowStr()}] cursize: ${prettyData(payload ?? e.data)}`);
      setLast("cursize", payload ?? e.data);

      if (!payload) return;

      const fileName = payload.fileName;
      const currentSize = payload.size;

      const newMediaList = [...mediaListRef.current];
      const idx = newMediaList.findIndex((m) => m.fileName === fileName);

      if (idx !== -1) {
        const fileSize = newMediaList[idx].fileSize;
        if (typeof fileSize === "number" && fileSize > 0) {
          const percentage = Math.ceil((currentSize / fileSize) * 100);
          newMediaList[idx].progress = percentage;
        } else {
          newMediaList[idx].progress = 0;
        }
        mediaListRef.current = newMediaList;
        setMediaList(newMediaList);
        renderMediaList();
      }
    });

    source.addEventListener("complete", (e) => {
      const payload = safeJsonParse(e.data);
      logLine(`[${nowStr()}] complete: ${prettyData(payload ?? e.data)}`);
      setLast("complete", payload ?? e.data);

      if (!payload) return;

      const fileName = payload.fileName;
      const newMediaList = [...mediaListRef.current];
      const idx = newMediaList.findIndex((m) => m.fileName === fileName);

      if (idx !== -1) {
        newMediaList[idx].isLoading = false;
        newMediaList[idx].progress = false;
        mediaListRef.current = newMediaList;
        setMediaList(newMediaList);
        renderMediaList();
      }
    });

    source.addEventListener("abort", (e) => {
      const payload = safeJsonParse(e.data);
      logLine(`[${nowStr()}] abort: ${prettyData(payload ?? e.data)}`);
      setLast("abort", payload ?? e.data);

      if (!payload) return;

      const fileName = payload.fileName;
      const newMediaList = [...mediaListRef.current];
      const idx = newMediaList.findIndex((m) => m.fileName === fileName);

      if (idx !== -1) {
        newMediaList[idx].isLoading = false;
        mediaListRef.current = newMediaList;
        setMediaList(newMediaList);
        renderMediaList();
      }
    });

    source.addEventListener("delete", (e) => {
      const payload = safeJsonParse(e.data);
      logLine(`[${nowStr()}] delete: ${prettyData(payload ?? e.data)}`);
      setLast("delete", payload ?? e.data);

      if (!payload) return;

      const fileName = payload.fileName;
      const newMediaList = [...mediaListRef.current];
      const idx = newMediaList.findIndex((m) => m.fileName === fileName);

      if (idx !== -1) {
        newMediaList.splice(idx, 1);
        mediaListRef.current = newMediaList;
        setMediaList(newMediaList);
        renderMediaList();
      }
    });

    return () => {
      try { source?.close(); } catch {}
      source = null;
      setStatus(false);
      logLine(`[${nowStr()}] closed`);
    };
  }

  // ===== UI wiring =====
  let closeSse = null;

  function resetCountersAndState() {
    Object.keys(counters).forEach(k => {
      counters[k] = 0;
      const el = $("cnt_" + k);
      if (el) el.textContent = "0";
    });

    $("state_volume").textContent = "-";
    $("state_status").textContent = "-";
    $("state_position").textContent = "-";
    $("state_duration").textContent = "-";
    $("state_urls").textContent = "-";
    $("state_raw").textContent = "{}";
  }

  function connect() {
    if (closeSse) closeSse();

    const url = $("url").value.trim();
    logLine(`[${nowStr()}] connect -> ${url}`);

    closeSse = createSseConnection({
      url,
      setSseError: (err) => logLine(`[${nowStr()}] setSseError: ${err}`),
      handleConDis: (_e, status) => logLine(`[${nowStr()}] handleConDis: ${status}`),
      setMediaList: (_newList) => {},
    });
  }

  function disconnect() {
    if (closeSse) closeSse();
    closeSse = null;
  }

  $("btnConnect").addEventListener("click", connect);
  $("btnDisconnect").addEventListener("click", disconnect);

  $("btnClear").addEventListener("click", () => {
    $("log").textContent = "";
    $("lastEvent").textContent = "-";
    $("lastType").textContent = "-";
    $("lastTime").textContent = "-";
    $("lastData").textContent = "{}";

    mediaListRef.current = [];
    renderMediaList();

    resetCountersAndState();

    // webhook output
    setWhStatus("idle");
    $("whOut").textContent = "-";
  });

  // start
  setStatus(false);
  renderMediaList();
  resetCountersAndState();
  connect();
</script>

</body>
</html>